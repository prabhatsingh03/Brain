<!DOCTYPE html>
<html lang="en" class="">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='images/favicon.ico') }}">
    <title>Shared Chat â€“ SIA</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/output.css') }}?v=4">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/simon_upgrade.css') }}?v=4">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            font-family: 'Inter', sans-serif;
        }

        body {
            display: flex;
            flex-direction: column;
            background: var(--simon-bg, #0f172a);
            color: var(--simon-text-main, #e2e8f0);
        }

        .shared-header {
            flex-shrink: 0;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(15, 23, 42, 0.9);
        }

        .shared-header h1 {
            margin: 0;
            font-size: 1.125rem;
            font-weight: 600;
        }

        .shared-badge {
            font-size: 0.75rem;
            color: var(--simon-text-muted, #94a3b8);
        }

        #chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem 2rem;
            max-width: 56rem;
            margin: 0 auto;
            width: 100%;
        }

        .shared-error {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            text-align: center;
            color: var(--simon-text-muted);
        }

        .simon-markdown {
            color: var(--simon-text-main);
            font-size: 1rem;
            line-height: 1.7;
        }

        .simon-markdown h1,
        .simon-markdown h2,
        .simon-markdown h3 {
            color: var(--simon-secondary);
            font-family: 'Outfit', sans-serif;
            font-weight: 700;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
        }

        .simon-markdown p {
            margin-bottom: 1rem;
            color: var(--simon-text-muted);
        }

        .simon-markdown ul,
        .simon-markdown ol {
            margin-left: 1.5rem;
            margin-bottom: 1rem;
        }

        .simon-markdown a {
            color: var(--simon-accent);
            text-decoration: none;
        }

        .simon-markdown code {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.2em 0.4em;
            border-radius: 0.25em;
            font-size: 0.9em;
        }

        .simon-markdown pre {
            background: #0f172a;
            padding: 1.25rem;
            border-radius: 0.75rem;
            overflow-x: auto;
            margin-bottom: 1.5rem;
        }

        .simon-markdown pre code {
            background: transparent;
            padding: 0;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .reactor-avatar {
            position: relative;
            width: 3.5rem;
            height: 3.5rem;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .reactor-avatar .reactor-glow {
            position: absolute;
            inset: 0;
            background: linear-gradient(to top right, rgb(6 182 212), rgb(59 130 246), rgb(147 51 234));
            border-radius: 9999px;
            filter: blur(12px);
            opacity: 0.4;
        }

        .reactor-avatar .reactor-housing {
            position: relative;
            width: 100%;
            height: 100%;
            background: #030a16;
            border-radius: 1rem;
            border: 1px solid rgba(6, 182, 212, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .reactor-avatar .reactor-hexagon {
            position: absolute;
            inset: 0;
            opacity: 0.2;
            background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M10 0l5 5v10l-5 5-5-5V5z' fill='%2306b6d4' fill-opacity='0.4'/%3E%3C/svg%3E");
            animation: spin 20s linear infinite;
        }

        .reactor-avatar .reactor-ring-outer {
            position: absolute;
            inset: 4px;
            border: 1px dashed rgba(6, 182, 212, 0.6);
            border-radius: 9999px;
            animation: spin 10s linear infinite;
        }

        .reactor-avatar .reactor-ring-inner {
            position: absolute;
            inset: 8px;
            border: 2px solid rgba(217, 70, 239, 0.8);
            border-radius: 9999px;
            border-bottom-color: transparent;
            border-left-color: transparent;
            animation: spin 3s ease-in-out infinite reverse;
        }

        .reactor-avatar .reactor-core {
            position: relative;
            z-index: 10;
            width: 1.5rem;
            height: 1.5rem;
            background: linear-gradient(to bottom right, rgb(103 232 249), rgb(37 99 235));
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .reactor-avatar .reactor-core svg {
            width: 1rem;
            height: 1rem;
            color: white;
        }

        .reactor-avatar .reactor-scan {
            position: absolute;
            width: 100%;
            height: 2px;
            background: rgba(255, 255, 255, 0.5);
            animation: scan 2s ease-in-out infinite;
            opacity: 0.7;
        }

        .reactor-avatar .reactor-corner-tl {
            position: absolute;
            top: 0;
            left: 0;
            width: 8px;
            height: 8px;
            border-top: 1px solid rgba(6, 182, 212, 1);
            border-left: 1px solid rgba(6, 182, 212, 1);
        }

        .reactor-avatar .reactor-corner-br {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 8px;
            height: 8px;
            border-bottom: 1px solid rgba(6, 182, 212, 1);
            border-right: 1px solid rgba(6, 182, 212, 1);
        }

        @keyframes scan {
            0% {
                top: -20%;
                opacity: 0;
            }

            50% {
                opacity: 0.7;
            }

            100% {
                top: 120%;
                opacity: 0;
            }
        }

        .simon-avatar.reactor-avatar-wrapper {
            background: transparent;
            border: none;
            box-shadow: none;
        }

        .simon-avatar.reactor-avatar-wrapper::before {
            display: none;
        }

        .simon-message-group.assistant {
            flex-direction: row !important;
        }

        /* ===== LIGHT MODE FOR SHARED CHAT ===== */
        html:not(.dark) body {
            background: #F8FAFC;
            background-image:
                radial-gradient(at 0% 0%, rgba(59, 130, 246, 0.05) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(14, 165, 233, 0.05) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(244, 63, 94, 0.02) 0px, transparent 50%),
                radial-gradient(at 0% 100%, rgba(109, 93, 252, 0.03) 0px, transparent 50%);
            color: #1E293B;
        }

        html:not(.dark) .shared-header {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom-color: #E2E8F0;
        }

        html:not(.dark) .shared-header h1 {
            color: #0F172A;
        }

        html:not(.dark) .shared-badge {
            color: #64748B;
        }

        /* Reactor Avatar Light Mode */
        html:not(.dark) .reactor-avatar .reactor-housing {
            background: #FFFFFF;
            border-color: rgba(0, 102, 255, 0.3);
        }

        html:not(.dark) .reactor-avatar .reactor-glow {
            background: linear-gradient(to top right, rgba(0, 102, 255, 0.3), rgba(14, 165, 233, 0.3), rgba(59, 130, 246, 0.3));
        }

        html:not(.dark) .reactor-avatar .reactor-ring-outer {
            border-color: rgba(0, 102, 255, 0.6);
        }

        html:not(.dark) .reactor-avatar .reactor-scan {
            background: rgba(0, 102, 255, 0.5);
        }

        html:not(.dark) .reactor-avatar .reactor-corner-tl,
        html:not(.dark) .reactor-avatar .reactor-corner-br {
            border-color: #0066FF;
        }

        /* Markdown Elements */
        html:not(.dark) .simon-markdown h1,
        html:not(.dark) .simon-markdown h2,
        html:not(.dark) .simon-markdown h3 {
            color: #0F172A;
        }

        html:not(.dark) .simon-markdown p {
            color: #475569;
        }

        html:not(.dark) .simon-markdown a {
            color: #0066FF;
        }

        html:not(.dark) .simon-markdown code {
            background: #F1F5F9;
            color: #0066FF;
        }

        html:not(.dark) .simon-markdown pre {
            background: #F1F5F9;
            border: 1px solid #E2E8F0;
        }

        html:not(.dark) .simon-markdown pre code {
            color: #0F172A;
        }

        html:not(.dark) .shared-error {
            color: #64748B;
        }
    </style>
</head>

<body data-token="{{ token if token else '' }}" data-invalid="{{ 'true' if invalid else 'false' }}">
    <header class="shared-header">
        <h1 id="shared-title">Shared chat</h1>
        <span class="shared-badge">View only</span>
    </header>
    <div id="chat-messages" role="region" aria-label="Chat messages"></div>
    <div id="shared-error" class="shared-error" style="display: none;">
        <p>This link is invalid or has expired.</p>
    </div>
    <script>
        (function () {
            const body = document.body;
            const token = body.getAttribute('data-token') || null;
            const invalid = body.getAttribute('data-invalid') === 'true';
            const messagesEl = document.getElementById('chat-messages');
            const errorEl = document.getElementById('shared-error');
            const titleEl = document.getElementById('shared-title');

            const AI_ICON_URL = "{{ url_for('static', filename='images/sia_crazy_icon.png') }}";
            const REACTOR_AVATAR_HTML = '<div class="reactor-avatar">' +
                '<div class="reactor-glow"></div>' +
                '<div class="reactor-housing">' +
                '<div class="reactor-hexagon"></div>' +
                '<div class="reactor-ring-outer"></div>' +
                '<div class="reactor-ring-inner"></div>' +
                '<div class="reactor-core overflow-hidden relative">' +
                '<img src="' + AI_ICON_URL + '" class="w-full h-full object-contain scale-110" alt="AI Core">' +
                '<div class="absolute inset-0 bg-cyan-400/10 mix-blend-overlay"></div>' +
                '</div><div class="reactor-scan"></div>' +
                '<div class="reactor-corner-tl"></div><div class="reactor-corner-br"></div>' +
                '</div></div>';

            function appendMessage(role, text, visuals) {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'simon-message-group ' + role + ' visible';
                const avatarDiv = document.createElement('div');
                avatarDiv.className = role === 'user' ? 'simon-avatar user' : 'simon-avatar assistant reactor-avatar-wrapper';
                if (role === 'user') {
                    avatarDiv.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>';
                } else {
                    avatarDiv.innerHTML = REACTOR_AVATAR_HTML;
                }
                const bubble = document.createElement('div');
                bubble.className = 'simon-chat-bubble ' + role;
                if (role === 'assistant') bubble.classList.add('simon-markdown');
                groupDiv.appendChild(avatarDiv);
                groupDiv.appendChild(bubble);
                messagesEl.appendChild(groupDiv);
                if (role === 'assistant' && typeof marked !== 'undefined') {
                    bubble.innerHTML = marked.parse(text);

                    // Render visuals if available
                    if (visuals && visuals.length > 0) {
                        visuals.forEach(function (vis) {
                            const pages = Array.isArray(vis.pages) ? vis.pages : [0];
                            pages.forEach(function (pg) {
                                const card = document.createElement('div');
                                card.className = "mt-4 bg-black/20 p-2 rounded-xl border border-white/10 w-full max-w-md group relative";

                                const imgContainer = document.createElement('div');
                                imgContainer.className = "relative overflow-hidden rounded border border-white/10";

                                const encodedPath = encodeURIComponent(vis.file_path);
                                const imgSrc = `{{ url_for('main.serve_visual') }}?path=${encodedPath}&page=${pg}`;

                                const img = document.createElement('img');
                                img.src = imgSrc;
                                img.className = "w-full";

                                imgContainer.appendChild(img);
                                card.appendChild(imgContainer);
                                bubble.appendChild(card);
                            });
                        });
                    }
                } else {
                    bubble.textContent = text;
                    bubble.innerHTML = text.replace(/\n/g, '<br>');
                }
                return bubble;
            }

            if (invalid || !token) {
                messagesEl.style.display = 'none';
                errorEl.style.display = 'flex';
                return;
            }

            fetch('/api/chat/shared/' + encodeURIComponent(token))
                .then(function (res) {
                    if (!res.ok) throw new Error('Not found');
                    return res.json();
                })
                .then(function (data) {
                    titleEl.textContent = data.session_title || 'Shared chat';
                    data.messages.forEach(function (m) {
                        appendMessage('user', m.question);
                        appendMessage('assistant', m.answer, m.visuals);
                    });
                    messagesEl.scrollTop = messagesEl.scrollHeight;
                })
                .catch(function () {
                    messagesEl.style.display = 'none';
                    errorEl.style.display = 'flex';
                });
        })();
    </script>
</body>

</html>